name: Canary Release
on:
  push:
    branches:
      - main
      - master

jobs:
  up:
    name: Deploy to GCP
    runs-on: ubuntu-latest
    env:
      SERVICE_NAME: "{{github.name}}"
      ENVIRONMENT: dev
      VERSION: v1
      REGION: europe-north1
      IMAGE_NAME: eu.gcr.io/indiv-app-dev/{{github.name}}
      V_TAG: v1.$(git rev-parse --short=4 $\{{ github.sha }})
    steps:
      - uses: actions/checkout@v1
        with:
          fetch-depth: 1

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@master
        with:
          project_id: indiv-app-dev
          service_account_key: $\{{ secrets.GCP_SERVICE_ACCOUNT_JSON }}
          export_default_credentials: true

      - run: gcloud auth configure-docker

      - run: docker build --build-arg NPM_TOKEN=$\{{ env.NPM_TOKEN }} . -t $\{{ env.IMAGE_NAME }}:$\{{ env.V_TAG }}
        env:
          NPM_TOKEN: $\{{ secrets.GH_NPM_TOKEN }}

      - run: docker tag $\{{ env.IMAGE_NAME }}:$\{{ env.V_TAG }} $\{{ env.IMAGE_NAME }}:$\{{ env.VERSION }}-dev

      - run: docker push $\{{ env.IMAGE_NAME }}

      - run: gcloud run deploy $\{{ env.SERVICE_NAME }}-dev-$\{{ env.VERSION }} --platform managed --image=$\{{ env.IMAGE_NAME }}:$\{{ env.V_TAG }} --region $\{{ env.REGION }}
